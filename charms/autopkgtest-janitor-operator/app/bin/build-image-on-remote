#!/bin/sh

set -eu

# $1 expected in form: arch-release-type, with type either "container" or "vm".
IFS=- read -r arch RELEASE type <<EOF
$1
EOF

export RELEASE

remote="remote-$arch"
imgremote="ubuntu-daily"
base=$RELEASE

basearch=$arch
if [ "$basearch" = amd64v3 ]; then
    basearch=amd64
fi

if [ -z "${MIRROR-}" ]; then
    echo 'MIRROR environment variable is not set, the image default will be used'
fi

# If $RELEASE is the devel release (or is unknown), and there are no images for
# it, fallback to stable up to $max_stable_age_days days after stable has been
# released (i.e. in a limited time window early in the $RELEASE development
# cycle). We want to be careful and avoid falling back to stable in corner
# cases like very outdated distro-info-data, network hiccups or similar.
max_stable_age_days=60
stable=$(ubuntu-distro-info --stable) || exit 1
stable_release_age=$(ubuntu-distro-info --days=release --stable)
devel=$(ubuntu-distro-info --devel) || devel=UNKNOWN
set -- lxc image info
if
    # $RELEASE is devel release or unknown
    ([ "$RELEASE" = "$devel" ] || ubuntu-distro-info --all | { ! grep -q "$RELEASE"; }) &&
    # stable is young, i.e. we are early in the $RELEASE cycle
    [ "$stable_release_age" -ge "-$max_stable_age_days" ] &&
    # there are no images for $RELEASE
    "$@" "$imgremote:$base/$basearch" 2>&1 | grep -q "couldn't be found" &&
    # there are image for stable
    "$@" "$imgremote:$stable/$basearch" >/dev/null 2>&1
then
    echo "No $base image appears to be available, falling back to $stable"
    base=$stable
fi

# Construct the autopkgtest-build-lxd command line in $@.
set -- autopkgtest-build-lxd
if [ "$type" = "vm" ]; then
    set -- "$@" --vm
fi
set -- "$@" --remote "$remote" "ubuntu-daily:$base/$arch"

# If RUNTIME_DIRECTORY is set, which normally happens when this script
# is started from the systemd service, then limit to one image build
# per architecture (remote).
if [ -d "${RUNTIME_DIRECTORY-}" ]; then
    set -- flock --verbose "$RUNTIME_DIRECTORY/$arch.lock" "$@"
fi

exec "$@"
