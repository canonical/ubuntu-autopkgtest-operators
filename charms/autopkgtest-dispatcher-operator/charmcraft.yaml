name: ubuntu-autopkgtest-dispatcher
type: charm
summary: A charm that deploys an autopkgtest queue dispatcher
description: A charm that deploys an autopkgtest queue dispatcher
links:
  issues:
    - https://github.com/canonical/ubuntu-autopkgtest-operators/issues
  source:
    - https://github.com/canonical/ubuntu-autopkgtest-operators

base: ubuntu@24.04
platforms:
  amd64:
    build-on: [amd64]
    build-for: [amd64]

charm-libs:
  - lib: operator_libs_linux.systemd
    version: "1"

parts:
  charm:
    plugin: charm
    source: .
  systemd-units:
    plugin: dump
    source: .
    stage:
      - units/*

actions:
  reconfigure:
    description: Reconfigure workers.
  add-remote:
    description: Add a remote to run tests on.
    params:
      arch:
        type: string
        description: Architecture of the remote.
        enum: [amd64, amd64v3, i386, arm64, armhf, s390x, ppc64el, riscv64]
      token:
        type: string
        description: LXD client token to connect to a remote.
  set-worker-count:
    description: Set number of workers for a given architecture.
    params:
      arch:
        type: string
        description: Architecture to set units for.
        enum: [amd64, amd64v3, i386, arm64, armhf, s390x, ppc64el, riscv64]
      count:
        type: integer
        description: Number of workers.
        min: 0
  show-target-config:
    description: Show target config for worker units.
  reconcile-worker-units:
    description: Enable/disable worker units according to target config.

config:
  options:
    # charm options
    autopkgtest-git-branch:
      type: string
      description: salsa.debian.org/ubuntu-ci-team/autopkgtest branch to clone.
      default: ubuntu/staging
    default-worker-count:
      type: int
      description: Default number of workers to create for each remote.
      default: 10
    releases:
      type: string
      description: Space-separated of releases to run tests for
      default: trusty xenial bionic focal jammy noble plucky questing resolute

    # swift
    swift-auth-url:
      type: string
      description: swift auth URL
      default: ""
    swift-username:
      type: string
      description: username for swift
      default: ""
    swift-project-domain-name:
      type: string
      description: swift project domain
      default: ""
    swift-project-name:
      type: string
      description: swift project name
      default: ""
    swift-user-domain-name:
      type: string
      description: swift user domain name
      default: ""
    swift-juju-secret:
      type: secret
      description: juju secret id holding the swift password

requires:
  amqp:
    interface: rabbitmq
    limit: 1
