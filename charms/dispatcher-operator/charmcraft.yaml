name: autopkgtest-dispatcher
type: charm
summary: A charm that deploys an autopkgtest queue dispatcher, to run tests on available workers
description: A charm that deploys an autopkgtest queue dispatcher, to run tests on available workers
links:
  issues:
    - https://github.com/canonical/ubuntu-autopkgtest-operators/issues
  source:
    - https://github.com/canonical/ubuntu-autopkgtest-operators

base: ubuntu@24.04
platforms:
  amd64:
    build-on: [amd64]
    build-for: [amd64]

# different components of operator_libs_linux are only available
# in different versions of the library
charm-libs:
  - lib: operator_libs_linux.apt
    version: "0"
  - lib: operator_libs_linux.systemd
    version: "1"
  - lib: operator_libs_linux.snap
    version: "2"

parts:
  charm:
    plugin: charm
    source: .
    charm-binary-python-packages:
      - amqp
      - pydantic
  systemd-units:
    plugin: dump
    source: .
    stage:
      - units/*

actions:
  add-worker:
    description: Add a worker to run tests on.
    params:
      arch:
        type: string
        description: Architecture of the worker.
        enum: [amd64, amd64v3, i386, arm64, armhf, s390x, ppc64el, riscv64]
      token:
        type: string
        description: LXD client token to connect to a remote.
  set-unit-count:
    description: Set number of units on a worker.
    params:
      arch:
        type: string
        description: Architecture to set units for.
        enum: [amd64, amd64v3, i386, arm64, armhf, s390x, ppc64el, riscv64]
      count:
        type: integer
        description: Number of units.
        min: 0
  show-target-config:
    description: Show target config for worker units.
  create-worker-units:
    description: Create worker units for target config.

config:
  options:
    # charm options
    default-worker-count:
      type: int
      description: Default number of workers to create for a cluster.
      default: 10
    releases:
      type: string
      description: Space-separated list of releases to test.
      default: trusty xenial bionic focal jammy noble plucky questing
    worker-upstream-percentage:
      type: int
      description: Percent chance that a test will be run from the upstream queue when its turn comes up.
      min: 0
      max: 100
      default: 33
    stable-release-percentage:
      type: int
      description: Percent chance that a test will be run from stable releases.
      min: 0
      max: 100
      default: 100

    # swift
    swift-auth-url:
      type: string
      description: swift auth URL
    swift-username:
      type: string
      description: username for swift
    swift-password:
      type: string
      description: password for swift
    swift-region:
      type: string
      description: swift region to use
    swift-project-domain-name:
      type: string
      description: swift project domain
    swift-project-name:
      type: string
      description: swift project name
    swift-user-domain-name:
      type: string
      description: swift user domain name

requires:
  amqp:
    interface: rabbitmq
